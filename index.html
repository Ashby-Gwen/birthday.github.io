<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Happy Birthday ‚Äî Interactive Letter</title>
    <style>
        :root {
            --bg-1: #0b1020;
            --bg-2: #0b3b6f;
            --card: #fffdf8;
            --accent1: #ff3b6f;
            --accent4: #6b8cff;
            --paper-width: 600px;
            --collage-width: 280px;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, Segoe UI, Roboto, 'Helvetica Neue', Arial;
            background: radial-gradient(1200px 600px at 10% 10%, rgba(255, 255, 255, 0.04), transparent 8%),
                linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 60%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Close Button Style --- */
        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: background 0.3s, transform 0.1s;
            display: none;
            /* Hide initially */
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* --- Stage Layout (Handles Centering and View Toggle) --- */
        .stage {
            /* Initial state: Centered in the middle of the body flex container */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 28px;
            width: 100%;
        }

        /* State when the envelope is opened (Desktop/Large Screen) */
        .stage.opened-view {
            flex-direction: row;
            align-items: flex-start;
            max-width: 960px;
            justify-content: center;
        }

        /* --- Envelope --- */
        .envelope {
            width: 300px;
            height: 200px;
            background: linear-gradient(180deg, #ff3b6f, #6b8cff);
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-weight: 800;
            font-size: 22px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            transition: transform 0.5s ease, opacity 0.5s ease;
            flex-shrink: 0;
        }

        .envelope.opened {
            transform: scale(0.9) rotateX(180deg);
            opacity: 0;
        }

        /* --- Card & Letter Area --- */
        .card,
        .photo-wrap {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease;
            /* Added transition for fade out */
        }

        .fade-out {
            opacity: 0 !important;
        }

        .card {
            width: var(--paper-width);
            max-width: 90%;
            background: var(--card);
            border-radius: 16px;
            padding: 26px;
            box-shadow: 0 30px 80px rgba(6, 15, 40, 0.6);
            position: relative;
            overflow: hidden;
            display: none;
            flex-shrink: 0;
        }

        .letter-area {
            background: linear-gradient(180deg, #fffefc 0%, #fff6ee 100%);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(10, 30, 50, 0.04);
            min-height: 320px;
            position: relative;
            overflow: hidden;
        }

        .letter {
            font-size: 20px;
            color: #0b2540;
            line-height: 1.6;
        }

        .confetti-canvas,
        #balloonLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
        }

        /* --- Balloon Styles --- */
        @keyframes rise {
            from {
                transform: translateY(100vh);
            }

            to {
                transform: translateY(-100%);
            }
        }

        .balloon {
            position: absolute;
            bottom: -10%;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: inset -10px -10px 0 rgba(0, 0, 0, 0.08);
            z-index: 4;
        }

        .balloon::after {
            content: "";
            position: absolute;
            bottom: -12px;
            left: 50%;
            width: 15px;
            height: 15px;
            background: #d09c27;
            border-radius: 50%;
            transform: translateX(-50%);
            z-index: -1;
        }

        .string {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 120px;
            background: #555;
            opacity: 0.6;
        }

        /* --- Photo Collage Styles & Animations --- */
        .photo-wrap {
            width: var(--collage-width);
            flex-shrink: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .collage {
            width: var(--collage-width);
            height: 400px;
            position: relative;
        }

        .photo {
            border-radius: 12px;
            overflow: hidden;
            background: var(--card);
            border: 3px solid rgba(255, 59, 111, 0.08);
            position: absolute;
            box-shadow: 0 16px 40px rgba(11, 30, 70, 0.35);
            transform-origin: center;
            animation-iteration-count: infinite;
            animation-direction: alternate;
            will-change: transform;
        }

        .photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            /* Placeholder images */
            background-color: #f7e0e7;
            background-image: url('https://placehold.co/160x160/9c3e60/ffffff?text=Photo');
        }

        /* Animation Keyframes for Floating Effect */
        @keyframes floatA {
            from {
                transform: translateY(0px) rotate(-3deg);
            }

            to {
                transform: translateY(-12px) rotate(-1deg);
            }
        }

        @keyframes floatB {
            from {
                transform: translateY(0px) rotate(5deg);
            }

            to {
                transform: translateY(-8px) rotate(3deg);
            }
        }

        @keyframes floatC {
            from {
                transform: translateY(0px) rotate(1deg);
            }

            to {
                transform: translateY(-16px) rotate(0deg);
            }
        }

        @keyframes floatD {
            from {
                transform: translateY(0px) rotate(-7deg);
            }

            to {
                transform: translateY(-10px) rotate(-5deg);
            }
        }

        @keyframes floatE {
            from {
                transform: translateY(0px) rotate(3deg);
            }

            to {
                transform: translateY(-14px) rotate(4deg);
            }
        }


        /* individual photo positions/sizes and unique animations */
        .p1 {
            width: 160px;
            height: 160px;
            left: 10px;
            top: 10px;
            z-index: 5;
            animation: floatA 3.5s ease-in-out infinite alternate;
        }

        .p2 {
            width: 120px;
            height: 90px;
            right: 8px;
            top: 10px;
            z-index: 6;
            animation: floatB 2.2s ease-in-out 0.5s infinite alternate;
        }

        .p3 {
            width: 130px;
            height: 180px;
            left: 20px;
            bottom: 10px;
            z-index: 7;
            animation: floatC 4.8s ease-in-out 0.2s infinite alternate;
        }

        .p4 {
            width: 100px;
            height: 100px;
            right: 10px;
            bottom: 120px;
            z-index: 8;
            animation: floatD 2.9s ease-in-out 0.8s infinite alternate;
        }

        .p5 {
            width: 80px;
            height: 60px;
            right: 10px;
            bottom: 20px;
            z-index: 9;
            animation: floatE 4.1s ease-in-out 1.1s infinite alternate;
        }

        /* --- Responsive Mobile Layout --- */
        @media (max-width: 900px) {
            .close-button {
                /* Move button below the header on small screens */
                top: 20px;
                right: 50%;
                transform: translateX(50%);
            }

            .stage.opened-view {
                flex-direction: column;
                /* Stack vertically on small screens */
                align-items: center;
                max-width: 100%;
                padding: 60px 0 40px;
                /* Added top padding to account for button */
            }

            .card {
                width: 95%;
            }

            .photo-wrap {
                order: -1;
                /* Move photos above the letter on mobile */
                margin-bottom: 20px;
                width: 95%;
            }

            .collage {
                width: 280px;
                margin: 0 auto;
            }
        }
    </style>
</head>

<body>
    <!-- Close Button - positioned absolutely outside the stage flow -->
    <button id="closeButton" class="close-button">
        ‚ùå Close
    </button>

    <div class="stage" id="stage">
        <!-- Envelope - Perfectly centered by the body flexbox -->
        <div class="envelope" id="envelope">üì© Open Me!</div>

        <!-- Letter card -->
        <div class="card" id="card">
            <div class="letter-area" id="letterArea">
                <canvas class="confetti-canvas" id="confetti"></canvas>
                <div id="balloonLayer" aria-hidden="true"></div>
                <div id="letter" class="letter">
                    üéâ Happy Birthday Papa! üéâ<br><br>
                    Wishing you a day filled with love, joy, and all the happiness in the world. Thank you for being an
                    amazing father and inspiration.<br><br>
                    These photos are some of our favorite memories together. Every day with you is a gift.<br><br>
                    Love, <br>
                    Mama<br>
                    Raprap<br>
                    Ashby
                </div>
            </div>
        </div>

        <!-- Photo Collage -->
        <div class="photo-wrap" id="photoWrap">
            <div class="collage">
                <!-- Note: Using placeholder image URLs. Replace with your actual paths! -->
                <div class="photo p1"><img src="photo1.jpg" alt="Family Photo 1"
                        onerror="this.src='https://placehold.co/160x160/9c3e60/ffffff?text=Photo+1'"></div>
                <div class="photo p2"><img src="photo2.jpg" alt="Family Photo 2"
                        onerror="this.src='https://placehold.co/120x90/9c3e60/ffffff?text=Photo+2'"></div>
                <div class="photo p3"><img src="photo3.jpg" alt="Family Photo 3"
                        onerror="this.src='https://placehold.co/130x180/9c3e60/ffffff?text=Photo+3'"></div>
                <div class="photo p4"><img src="photo4.jpg" alt="Family Photo 4"
                        onerror="this.src='https://placehold.co/100x100/9c3e60/ffffff?text=Photo+4'"></div>
                <div class="photo p5"><img src="photo5.jpg" alt="Family Photo 5"
                        onerror="this.src='https://placehold.co/80x60/9c3e60/ffffff?text=Photo+5'"></div>
            </div>
        </div>
    </div>

    <!-- background audio (Requires bday_song.mp3 in the same directory) -->
    <audio id="bgm" loop preload="auto">
        <source src="bday_song.mp3" type="audio/mpeg">
    </audio>


    <script>
        const stage = document.getElementById('stage');
        const envelope = document.getElementById('envelope');
        const card = document.getElementById('card');
        const photoWrap = document.getElementById('photoWrap');
        const bgm = document.getElementById('bgm');
        const closeButton = document.getElementById('closeButton');

        // Global variables for animation cleanup
        let confettiInterval;
        let balloonInterval;
        let confettiRAF;
        let balloonRAF;
        let stopEffectsCleanup = () => { }; // Placeholder for cleanup function

        // --- Open Letter Handler ---
        envelope.addEventListener('click', () => {
            // 1. Initial envelope transition
            envelope.classList.add('opened');

            // 2. Adjust stage layout (needed for centering new elements)
            stage.classList.add('opened-view');

            // 3. Wait for envelope transition to finish (600ms)
            setTimeout(() => {
                envelope.style.display = 'none';
                card.style.display = 'block';
                photoWrap.style.display = 'flex'; // Show the collage
                closeButton.style.display = 'block'; // Show the close button

                bgm.play().catch(e => console.log('Audio blocked:', e));
                stopEffectsCleanup = startEffects(); // Start effects and capture cleanup function
            }, 600);
        });

        // --- Close Letter Handler ---
        closeButton.addEventListener('click', closeLetter);

        function closeLetter() {
            // 1. Stop effects and music
            stopEffectsCleanup();
            bgm.pause();
            bgm.currentTime = 0; // Rewind music

            // 2. Hide the close button
            closeButton.style.display = 'none';

            // 3. Start fade out of the content
            card.classList.add('fade-out');
            photoWrap.classList.add('fade-out');

            // 4. After fade transition (600ms), reset state and show envelope
            setTimeout(() => {
                card.style.display = 'none';
                photoWrap.style.display = 'none';
                card.classList.remove('fade-out');
                photoWrap.classList.remove('fade-out');
                stage.classList.remove('opened-view');

                // Show envelope and reset its state
                envelope.style.display = 'flex';

                // Small delay for reflow before triggering the CSS transition back
                setTimeout(() => {
                    envelope.classList.remove('opened');
                }, 50);

            }, 600);
        }

        // --- Confetti + Balloon System (Start & Cleanup Logic) ---
        function startEffects() {
            const BALLOON_COLORS = [
                'linear-gradient(180deg,#ff3b6f,#ff6b9a)',
                'linear-gradient(180deg,#ffd166,#ffb46b)',
                'linear-gradient(180deg,#6ee7b7,#2ec49a)',
                'linear-gradient(180deg,#6b8cff,#4b6cff)'
            ];
            const POP_COLORS = ['#ff3b6f', '#ffd166', '#6ee7b7', '#6b8cff', '#c084fc', '#ff8ba7'];
            const letterArea = document.getElementById('letterArea');
            const balloonLayer = document.getElementById('balloonLayer');
            const confettiCanvas = document.getElementById('confetti');
            const ctx = confettiCanvas.getContext('2d');
            let particles = [];

            function resizeCanvas() {
                const r = window.devicePixelRatio || 1;
                confettiCanvas.width = letterArea.clientWidth * r;
                confettiCanvas.height = letterArea.clientHeight * r;
                confettiCanvas.style.width = letterArea.clientWidth + 'px';
                confettiCanvas.style.height = letterArea.clientHeight + 'px';
                ctx.setTransform(r, 0, 0, r, 0, 0);
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            function rand(min, max) { return Math.random() * (max - min) + min; }
            function makeParticle(x, y, dir) { return { x, y, vx: rand(80, 320) * (dir === 'left' ? 1 : -1) / 60, vy: rand(-8, -18), size: rand(6, 16), rot: rand(0, 360), vrot: rand(-14, 14), life: rand(100, 220), color: POP_COLORS[Math.floor(rand(0, POP_COLORS.length))] }; }

            function emitConfetti(amount = 80) {
                const rect = letterArea.getBoundingClientRect();
                for (let i = 0; i < amount; i++) {
                    const side = Math.random() > 0.5 ? 'left' : 'right';
                    const y = rand(20, rect.height - 20);
                    const x = side === 'left' ? -10 : rect.width + 10;
                    particles.push(makeParticle(x, y, side));
                }
            }

            function updateParticles() {
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx; p.y += p.vy; p.vy += 0.34; p.rot += p.vrot; p.life--;
                    if (p.y > letterArea.clientHeight + 60 || p.life <= 0) particles.splice(i, 1);
                }
            }

            function drawParticles() {
                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                for (const p of particles) {
                    ctx.save();
                    ctx.translate(p.x + 10, p.y + 10);
                    ctx.rotate(p.rot * Math.PI / 180);
                    ctx.fillStyle = p.color; ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
                    ctx.restore();
                }
            }

            // Confetti Animation Loop
            function confettiLoop() {
                updateParticles();
                drawParticles();
                confettiRAF = requestAnimationFrame(confettiLoop);
            }
            confettiRAF = requestAnimationFrame(confettiLoop);
            confettiInterval = setInterval(() => emitConfetti(140), 1000 + Math.random() * 800);

            // Balloons
            function spawnBalloon() {
                const b = document.createElement('div');
                b.className = 'balloon';
                const col = BALLOON_COLORS[Math.floor(Math.random() * BALLOON_COLORS.length)];
                b.style.background = col;
                const scale = 0.7 + Math.random() * 0.45;
                b.style.width = Math.round(80 * scale) + 'px';
                b.style.height = Math.round(110 * scale) + 'px';
                const leftPct = 8 + Math.random() * 84;
                b.style.left = leftPct + '%';
                const str = document.createElement('div'); str.className = 'string'; b.appendChild(str);
                const drift = (Math.random() * 80) - 40;
                const duration = Math.random() * 6 + 7;
                const delay = Math.random() * 1.2;
                b.style.animation = `rise ${duration}s linear ${delay}s forwards`;
                b.dataset.start = performance.now();
                b.dataset.duration = (duration + delay) * 1000;
                b.dataset.drift = drift;
                balloonLayer.appendChild(b);
                // Remove balloon element after it rises off-screen
                setTimeout(() => { if (b.parentNode) b.parentNode.removeChild(b); }, (duration + delay) * 1000 + 300);
            }

            balloonInterval = setInterval(spawnBalloon, 1200);

            // Balloon Drift Animation Loop
            function animateBalloons() {
                document.querySelectorAll('.balloon').forEach(b => {
                    const elapsed = (performance.now() - b.dataset.start) / 1000;
                    const duration = parseFloat(b.dataset.duration) / 1000;
                    const drift = parseFloat(b.dataset.drift);
                    const prog = Math.min(1, elapsed / duration);
                    const initialLeft = parseFloat(b.style.left) || 50;
                    b.style.left = (initialLeft + drift * prog) + '%';
                });
                balloonRAF = requestAnimationFrame(animateBalloons);
            }
            balloonRAF = requestAnimationFrame(animateBalloons);


            // Return the function to clean up all intervals and animation frames
            return function stopEffects() {
                clearInterval(confettiInterval);
                clearInterval(balloonInterval);
                cancelAnimationFrame(confettiRAF);
                cancelAnimationFrame(balloonRAF);
                balloonLayer.innerHTML = ''; // Clear all balloon elements
                particles = []; // Clear particles array
                window.removeEventListener('resize', resizeCanvas);
            }
        }
    </script>
</body>

</html>
